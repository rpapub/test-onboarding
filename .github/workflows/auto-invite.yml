name: Auto-Invite New Member
on:
  issues:
    types: [opened]

jobs:
  invite:
    runs-on: ubuntu-latest
    steps:
      - name: Check if issue is valid onboarding request
        id: check
        run: |
          BODY="${{ github.event.issue.body }}"
          if echo "$BODY" | grep -q "GitHub Username" && echo "$BODY" | grep -q "I agree to follow"; then
            echo "valid_request=true" >> $GITHUB_OUTPUT
          else
            echo "valid_request=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract username
        if: steps.check.outputs.valid_request == 'true'
        id: extract
        run: |
          USERNAME=$(echo "${{ github.event.issue.body }}" | grep -i "GitHub Username" -A 1 | tail -n 1 | xargs)
          echo "username=$USERNAME" >> $GITHUB_OUTPUT

      - name: Get GitHub user ID
        if: steps.check.outputs.valid_request == 'true'
        id: lookup
        run: |
          RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.ORG_RPAPUB_ADMIN_PAT }}" \
                         -H "Accept: application/vnd.github+json" \
                         https://api.github.com/users/${{ steps.extract.outputs.username }})
          USER_ID=$(echo "$RESPONSE" | jq '.id')
          echo "user_id=$USER_ID" >> $GITHUB_OUTPUT

      - name: Invite to Organization
        if: steps.check.outputs.valid_request == 'true'
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.ORG_RPAPUB_ADMIN_PAT }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/orgs/rpapub/invitations \
            -d '{"invitee_id": ${{ steps.lookup.outputs.user_id }} }'

      - name: Comment back on issue
        if: steps.check.outputs.valid_request == 'true'
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.ORG_RPAPUB_ADMIN_PAT }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -d '{"body":"ðŸŽ‰ Invitation sent to @${{ steps.extract.outputs.username }}! Please accept it to join the organization!"}'
